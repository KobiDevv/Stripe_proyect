<script>
    const stripe = Stripe("{{ publishable_key }}");

    const elements = stripe.elements();
    const card = elements.create("card", { hidePostalCode: true });
    card.mount("#card-element");

    const payButton = document.getElementById("payButton");
    const loader = document.getElementById("loader");
    const msg = document.getElementById("msg");

    function showMessage(text, type = "error") {
        msg.textContent = text;
        msg.className = "msg-box msg-" + (type === "success" ? "success" : "error");
        msg.style.display = "block";
    }

    payButton.addEventListener("click", async () => {
        const amount = document.getElementById("amount").value;

        if (!amount || amount <= 0) {
            showMessage("⚠️ Ingresa un monto válido");
            return;
        }

        msg.style.display = "none";
        payButton.disabled = true;
        loader.style.display = "block";

        const res = await fetch("/create-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
        });

        const data = await res.json();

        if (data.error) {
            showMessage("❌ Error: " + data.error);
            payButton.disabled = false;
            loader.style.display = "none";
            return;
        }

        const result = await stripe.confirmCardPayment(data.clientSecret, {
            payment_method: { card: card }
        });

        if (result.error) {
            showMessage("❌ Pago rechazado: " + result.error.message);
            payButton.disabled = false;
            loader.style.display = "none";
        } else {
            showMessage("✔ Pago exitoso, redirigiendo…", "success");
            setTimeout(() => { window.location.href = "/success"; }, 800);
        }
    });
</script>

            // 2 — confirmar pago
            const result = await stripe.confirmCardPayment(data.clientSecret, {
                payment_method: {
                    card: card
                }
            });

            if (result.error) {
                alert("Error en el pago: " + result.error.message);
                payButton.disabled = false;
                loader.style.display = "none";
            } else {
                window.location.href = "/success";
            }
        });
    </script>

</body>
</html>
